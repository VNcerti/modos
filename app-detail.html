<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết ứng dụng - XSpace Store</title>
    <link rel="icon" href="https://i.imgur.com/k0zikhA.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --secondary: #f59e0b;
            --background: #ffffff;
            --surface: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --info: #3b82f6;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --nav-height: 50px;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-light: #1e293b;
            --secondary: #f59e0b;
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
        }

        html {
            background-color: var(--background);
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            padding-bottom: var(--nav-height);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Header */
        .header {
            background: var(--background);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .back-btn:hover {
            background: var(--primary-light);
        }

        /* App Detail */
        .app-detail {
            padding: 30px 0;
        }

        .app-header {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-start;
        }

        .app-icon-large {
            width: 135px;
            height: 135px;
            border-radius: 21px;
            object-fit: contain;
            flex-shrink: 0;
            padding: 6px;
        }

        .app-info {
            flex: 1;
        }

        .app-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .app-developer {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .app-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .meta-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .meta-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .app-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .app-tag {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Download Section */
        .download-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .download-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .download-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .download-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
            height: 36px;
        }

        .download-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
        }

        .download-btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .download-btn-secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .download-btn-premium {
            background: linear-gradient(135deg, #f59e0b, #eab308);
            color: white;
        }

        .download-btn-premium:hover {
            background: linear-gradient(135deg, #eab308, #d97706);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);
        }

        .download-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* VIP Packages Info */
        .vip-packages-info {
            margin-top: 8px;
            padding: 8px;
            background: var(--surface);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .vip-packages-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vip-packages-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .vip-package-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
        }

        .vip-package-badge.trial {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .vip-package-badge.basic {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .vip-package-badge.plus {
            background: rgba(124, 58, 237, 0.15);
            color: #7c3aed;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .vip-package-badge.premium {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .vip-package-badge.all {
            background: rgba(37, 99, 235, 0.15);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        /* VIP Requirement Warning */
        .vip-requirement-warning {
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 6px;
            font-size: 10px;
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Custom Modal - ĐẸP HƠN */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(4px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .custom-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .modal-icon.success {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
        }

        .modal-icon.warning {
            background: linear-gradient(135deg, var(--warning), var(--warning-dark));
        }

        .modal-icon.error {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark));
        }

        .modal-icon.info {
            background: linear-gradient(135deg, var(--info), var(--primary-dark));
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .modal-message {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-details {
            background: var(--background);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .modal-btn.primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #5b21b6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .modal-btn.secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .modal-btn.secondary:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        .modal-btn.warning {
            background: linear-gradient(135deg, var(--warning), var(--warning-dark));
            color: white;
        }

        .modal-btn.warning:hover {
            background: linear-gradient(135deg, var(--warning-dark), #b45309);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .close-modal {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .close-modal:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--danger);
        }

        .error-icon {
            font-size: 36px;
            margin-bottom: 12px;
            color: var(--danger);
        }

        /* Login Prompt */
        .login-prompt {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .login-prompt p {
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border);
            padding: 6px 0;
            z-index: 1000;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            flex: 1;
            padding: 4px 0;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 9px;
            font-weight: 500;
        }

        /* Retry Button */
        .retry-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            margin-top: 15px;
        }

        .retry-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 20px;
            }
            
            .app-header {
                flex-direction: row;
                text-align: left;
                gap: 16px;
            }
            
            .app-icon-large {
                width: 135px;
                height: 135px;
            }
            
            .app-title {
                font-size: 20px;
            }
            
            .download-options {
                flex-direction: row;
            }
            
            .download-btn {
                min-width: 110px;
                font-size: 11.5px;
                padding: 7px 12px;
                height: 34px;
            }
            
            .modal-content {
                margin: 0 16px;
                padding: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 16px;
            }
            
            .app-detail {
                padding: 20px 0;
            }
            
            .app-header {
                flex-direction: row;
                align-items: flex-start;
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .app-icon-large {
                width: 135px;
                height: 135px;
                border-radius: 21px;
            }
            
            .app-info {
                flex: 1;
            }
            
            .app-title {
                font-size: 18px;
                margin-bottom: 4px;
            }
            
            .app-developer {
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            .app-meta {
                gap: 12px;
                margin-bottom: 10px;
            }
            
            .meta-item {
                gap: 2px;
            }
            
            .meta-label {
                font-size: 10px;
            }
            
            .meta-value {
                font-size: 12px;
            }
            
            .app-tag {
                font-size: 10px;
                padding: 3px 8px;
            }
            
            .download-section {
                padding: 10px 12px;
                margin-bottom: 18px;
                border-radius: 10px;
            }
            
            .download-title {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .download-options {
                flex-direction: column;
                gap: 6px;
            }
            
            .download-btn {
                width: 100%;
                min-width: auto;
                padding: 8px 12px;
                font-size: 12px;
                height: 34px;
                border-radius: 7px;
            }
            
            .modal-content {
                padding: 16px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .modal-message {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    XSpace Store
                </a>
                <a href="index.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </header>

    <!-- App Detail -->
    <main class="container">
        <div class="app-detail">
            <!-- Login Prompt -->
            <div class="login-prompt" id="loginPrompt" style="display: none;">
                <p>Vui lòng đăng nhập để tải ứng dụng</p>
                <button class="download-btn" onclick="showLoginModal()">
                    <i class="fas fa-sign-in-alt"></i>
                    Đăng nhập ngay
                </button>
            </div>

            <div id="appContent">
                <!-- Nội dung sẽ được thêm bằng JavaScript -->
            </div>
        </div>
    </main>

    <!-- Custom Modal -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-icon" id="modalIcon">
                <i class="fas fa-info-circle"></i>
            </div>
            <h2 class="modal-title" id="modalTitle">Thông báo</h2>
            <p class="modal-message" id="modalMessage">Đây là nội dung thông báo</p>
            <div class="modal-details" id="modalDetails" style="display: none;"></div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="modalCancelBtn" onclick="closeModal()" style="display: none;">
                    <i class="fas fa-times"></i>
                    Hủy
                </button>
                <button class="modal-btn primary" id="modalConfirmBtn" onclick="modalConfirmAction()">
                    <i class="fas fa-check"></i>
                    Xác nhận
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="container">
            <div class="nav-items">
                <a href="index.html" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="nav-label">Trang chủ</div>
                </a>
                <a href="#" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="nav-label">Hôm nay</div>
                </a>
                <a href="#" class="nav-item" id="searchNavItem">
                    <div class="nav-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="nav-label">Tìm kiếm</div>
                </a>
                <a href="#" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-gamepad"></i>
                    </div>
                    <div class="nav-label">Trò chơi</div>
                </a>
                <a href="https://t.me/m/inBUSKQ1N2E1" class="nav-item" target="_blank">
                    <div class="nav-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div class="nav-label">Yêu cầu</div>
                </a>
            </div>
        </div>
    </nav>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_-MluMh6fh7jl0Ai2iy6ojqX4UhjhjxRWj8RV8wRgNPUJHd6TphKwm6yPtYPm8hsCwg/exec';
        
        const urlParams = new URLSearchParams(window.location.search);
        const appId = urlParams.get('id');
        
        let retryCount = 0;
        const MAX_RETRIES = 3;
        let currentAppData = null;
        let modalCallback = null;

        // ==================== MODAL FUNCTIONS ====================
        
        function showModal(config) {
            const modal = document.getElementById('customModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalDetails = document.getElementById('modalDetails');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            
            // Thiết lập icon
            modalIcon.className = 'modal-icon';
            modalIcon.classList.add(config.type || 'info');
            modalIcon.innerHTML = `<i class="fas ${config.icon || 'fa-info-circle'}"></i>`;
            
            // Thiết lập nội dung
            modalTitle.textContent = config.title || 'Thông báo';
            modalMessage.textContent = config.message || '';
            
            // Thiết lập chi tiết
            if (config.details) {
                modalDetails.innerHTML = config.details;
                modalDetails.style.display = 'block';
            } else {
                modalDetails.style.display = 'none';
            }
            
            // Thiết lập nút hủy
            if (config.showCancel) {
                modalCancelBtn.style.display = 'flex';
                modalCancelBtn.innerHTML = `<i class="fas fa-times"></i> ${config.cancelText || 'Hủy'}`;
            } else {
                modalCancelBtn.style.display = 'none';
            }
            
            // Thiết lập nút xác nhận
            modalConfirmBtn.innerHTML = `<i class="fas fa-check"></i> ${config.confirmText || 'Xác nhận'}`;
            modalConfirmBtn.className = 'modal-btn';
            modalConfirmBtn.classList.add(config.confirmType || 'primary');
            
            // Lưu callback
            modalCallback = config.callback;
            
            // Hiển thị modal
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('customModal').classList.remove('active');
            modalCallback = null;
        }
        
        function modalConfirmAction() {
            if (modalCallback && typeof modalCallback === 'function') {
                modalCallback();
            }
            closeModal();
        }
        
        function showLoginModal() {
            showModal({
                type: 'info',
                icon: 'fa-sign-in-alt',
                title: 'Đăng nhập',
                message: 'Bạn cần đăng nhập để tiếp tục sử dụng tính năng này.',
                showCancel: true,
                cancelText: 'Để sau',
                confirmText: 'Đăng nhập ngay',
                confirmType: 'primary',
                callback: function() {
                    window.location.href = 'account.html';
                }
            });
        }
        
        function showPremiumModal(requiredPackage, currentPackage) {
            const packageNames = {
                'trial': 'Trial',
                'basic': 'Basic',
                'plus': 'Plus',
                'premium': 'Premium'
            };
            
            showModal({
                type: 'warning',
                icon: 'fa-crown',
                title: 'Nâng cấp tài khoản',
                message: `Tài khoản của bạn hiện không đủ điều kiện để tải ứng dụng này.`,
                details: `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div><strong>Gói yêu cầu:</strong> ${packageNames[requiredPackage] || requiredPackage}</div>
                        <div><strong>Gói hiện tại:</strong> ${packageNames[currentPackage] || currentPackage}</div>
                        <div style="margin-top: 8px; color: var(--warning);">
                            <i class="fas fa-exclamation-triangle"></i>
                            Vui lòng nâng cấp gói cao hơn để tiếp tục.
                        </div>
                    </div>
                `,
                showCancel: true,
                cancelText: 'Để sau',
                confirmText: 'Nâng cấp ngay',
                confirmType: 'warning',
                callback: function() {
                    window.location.href = 'payment.html';
                }
            });
        }
        
        function showDownloadModal(appName, isVIP) {
            showModal({
                type: 'info',
                icon: isVIP ? 'fa-crown' : 'fa-download',
                title: 'Xác nhận tải xuống',
                message: `Bạn muốn tải xuống ứng dụng "${appName}"?`,
                details: isVIP ? 
                    '<div style="color: var(--warning);"><i class="fas fa-star"></i> Đây là bản VIP với đầy đủ tính năng cao cấp.</div>' :
                    '<div><i class="fas fa-check"></i> Đây là bản miễn phí với các tính năng cơ bản.</div>',
                showCancel: true,
                cancelText: 'Hủy',
                confirmText: 'Tải ngay',
                confirmType: 'primary'
            });
        }
        
        function showErrorModal(message) {
            showModal({
                type: 'error',
                icon: 'fa-exclamation-triangle',
                title: 'Đã xảy ra lỗi',
                message: message,
                showCancel: false,
                confirmText: 'Đồng ý',
                confirmType: 'danger'
            });
        }
        
        function showSuccessModal(message) {
            showModal({
                type: 'success',
                icon: 'fa-check-circle',
                title: 'Thành công',
                message: message,
                showCancel: false,
                confirmText: 'Đồng ý',
                confirmType: 'primary'
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function clearCache() {
            try {
                localStorage.removeItem('xspace_apps_cache');
                localStorage.removeItem('xspace_cache_timestamp');
            } catch (e) {
                console.log('⚠️ Không thể xoá cache:', e);
            }
        }
        
        function showLoading() {
            document.getElementById('appContent').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Đang tải thông tin ứng dụng...</p>
                </div>
            `;
        }
        
        function showError(message, showRetry = true) {
            let retryButton = '';
            if (showRetry && retryCount < MAX_RETRIES) {
                retryButton = `
                    <button class="retry-btn" onclick="retryLoadApp()">
                        <i class="fas fa-redo"></i>
                        Thử lại
                    </button>
                `;
            }
            
            document.getElementById('appContent').innerHTML = `
                <div class="error-message">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Đã xảy ra lỗi</h3>
                    <p>${message}</p>
                    ${retryButton}
                    <button class="download-btn" onclick="window.location.href='index.html'" style="margin-top: 16px; max-width: 200px;">
                        <i class="fas fa-home"></i>
                        Quay về trang chủ
                    </button>
                </div>
            `;
        }
        
        function retryLoadApp() {
            retryCount++;
            loadAppDetail();
        }
        
        function isValidImageUrl(url) {
            if (!url || typeof url !== 'string') {
                return false;
            }
            
            const trimmedUrl = url.trim();
            
            if (trimmedUrl === '' || 
                trimmedUrl === 'null' || 
                trimmedUrl === 'undefined' ||
                trimmedUrl === '#' ||
                trimmedUrl.toLowerCase() === 'null' ||
                trimmedUrl.toLowerCase() === 'undefined' ||
                trimmedUrl === 'N/A' ||
                trimmedUrl === 'n/a') {
                return false;
            }
            
            const isUrl = trimmedUrl.startsWith('http://') || 
                         trimmedUrl.startsWith('https://') || 
                         trimmedUrl.startsWith('//') ||
                         trimmedUrl.includes('.jpg') || 
                         trimmedUrl.includes('.jpeg') || 
                         trimmedUrl.includes('.png') ||
                         trimmedUrl.includes('.gif') ||
                         trimmedUrl.includes('.webp') ||
                         trimmedUrl.includes('imgur.com') ||
                         trimmedUrl.includes('i.imgur.com') ||
                         trimmedUrl.includes('cdn.discordapp.com');
            
            return isUrl;
        }
        
        function canUserDownloadVip(vipPackages, userPackage) {
            if (!vipPackages || vipPackages.trim() === '') {
                return false;
            }
            
            const packages = vipPackages.split(',').map(p => p.trim());
            
            if (packages.includes('all')) {
                return true;
            }
            
            const packageOrder = ['trial', 'basic', 'plus', 'premium'];
            const userPackageIndex = packageOrder.indexOf(userPackage);
            
            if (userPackageIndex === -1) {
                return false;
            }
            
            for (const pkg of packages) {
                const packageIndex = packageOrder.indexOf(pkg);
                if (packageIndex !== -1 && userPackageIndex >= packageIndex) {
                    return true;
                }
            }
            
            return false;
        }

        // ==================== DISPLAY FUNCTIONS ====================
        
        function createVipPackagesHTML(vipPackages) {
            if (!vipPackages || vipPackages.trim() === '') {
                return '';
            }
            
            const packages = vipPackages.split(',').map(p => p.trim());
            let html = '<div class="vip-packages-info">';
            html += '<div class="vip-packages-label"><i class="fas fa-crown"></i> Gói được phép tải:</div>';
            html += '<div class="vip-packages-list">';
            
            packages.forEach(pkg => {
                const packageNames = {
                    'trial': 'Trial',
                    'basic': 'Basic',
                    'plus': 'Plus',
                    'premium': 'Premium',
                    'all': 'Tất cả các gói'
                };
                
                const packageClass = pkg === 'all' ? 'all' : pkg;
                const packageName = packageNames[pkg] || pkg;
                
                html += `
                    <span class="vip-package-badge ${packageClass}">
                        ${packageName}
                    </span>
                `;
            });
            
            html += '</div></div>';
            return html;
        }
        
        function createDownloadButton(app, isVIP, user) {
            const link = isVIP ? app.viplink1 : app.downloadlink;
            const isValidLink = link && isValidImageUrl(link.replace('image', 'http'));
            
            if (!isValidLink) {
                return `
                    <button class="download-btn ${isVIP ? 'download-btn-premium' : ''} disabled">
                        <i class="fas ${isVIP ? 'fa-crown' : 'fa-download'}"></i>
                        ${isVIP ? 'VIP #1' : 'Miễn phí'} (Đang cập nhật)
                    </button>
                `;
            }
            
            if (!user) {
                return `
                    <button class="download-btn ${isVIP ? 'download-btn-premium' : ''}" onclick="handleDownload('${app.name}', '${link}', ${isVIP}, null, '${app.vipPackages || ''}')">
                        <i class="fas ${isVIP ? 'fa-crown' : 'fa-download'}"></i>
                        ${isVIP ? 'Tải VIP #1' : 'Tải miễn phí'}
                    </button>
                `;
            }
            
            if (isVIP) {
                const canDownload = canUserDownloadVip(app.vipPackages, user.packageType);
                
                if (!canDownload) {
                    return `
                        <button class="download-btn download-btn-premium" onclick="handleVipRequirement('${app.name}', '${app.vipPackages || ''}', '${user.packageType}')">
                            <i class="fas fa-crown"></i>
                            Tải VIP #1
                        </button>
                        <div class="vip-requirement-warning">
                            <i class="fas fa-lock"></i>
                            Yêu cầu gói cao hơn
                        </div>
                    `;
                }
            }
            
            return `
                <button class="download-btn ${isVIP ? 'download-btn-premium' : ''}" onclick="handleDownload('${app.name}', '${link}', ${isVIP}, '${user.packageType}', '${app.vipPackages || ''}')">
                    <i class="fas ${isVIP ? 'fa-crown' : 'fa-download'}"></i>
                    ${isVIP ? 'Tải VIP #1' : 'Tải miễn phí'}
                </button>
            `;
        }
        
        function handleDownload(appName, link, isVIP, userPackage, vipPackages) {
            const user = getCurrentUser();
            
            if (!user) {
                showLoginModal();
                return;
            }
            
            if (isVIP) {
                const canDownload = canUserDownloadVip(vipPackages, user.packageType);
                if (!canDownload) {
                    handleVipRequirement(appName, vipPackages, user.packageType);
                    return;
                }
            }
            
            showDownloadModal(appName, isVIP);
            
            modalCallback = function() {
                if (!link || link === '#' || link === '' || link === 'null' || link === 'undefined') {
                    showErrorModal('⚠️ Link tải đang được cập nhật. Vui lòng thử lại sau.');
                    return;
                }
                
                window.open(link, '_blank');
                setTimeout(() => {
                    showSuccessModal(`✅ Đã bắt đầu tải xuống ${isVIP ? 'VIP' : 'miễn phí'}!`);
                }, 500);
            };
        }
        
        function handleVipRequirement(appName, vipPackages, currentPackage) {
            const packages = vipPackages.split(',').map(p => p.trim());
            
            const packageOrder = ['trial', 'basic', 'plus', 'premium'];
            let requiredPackage = null;
            
            for (const pkg of packages) {
                if (pkg === 'all') {
                    requiredPackage = 'trial';
                    break;
                }
                
                const packageIndex = packageOrder.indexOf(pkg);
                if (packageIndex !== -1) {
                    if (!requiredPackage || packageIndex < packageOrder.indexOf(requiredPackage)) {
                        requiredPackage = pkg;
                    }
                }
            }
            
            if (requiredPackage) {
                showPremiumModal(requiredPackage, currentPackage || 'free');
            }
        }

        // ==================== USER FUNCTIONS ====================
        
        function getCurrentUser() {
            try {
                const userStr = localStorage.getItem('currentUser');
                return userStr ? JSON.parse(userStr) : null;
            } catch (e) {
                return null;
            }
        }

        // ==================== LOAD APP DETAIL ====================
        
        async function loadAppDetail() {
            if (!appId) {
                showError('Không tìm thấy ID ứng dụng', false);
                return;
            }
            
            clearCache();
            showLoading();
            
            try {
                const timestamp = Date.now();
                const url = `${GOOGLE_SCRIPT_URL}?action=getApps&t=${timestamp}&nocache=true`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const app = result.data.find(a => {
                        return a.id == appId || a.id === appId || a.id.toString() === appId.toString();
                    });
                    
                    if (app) {
                        currentAppData = app;
                        displayAppDetail(app);
                        retryCount = 0;
                    } else {
                        showError(`Không tìm thấy ứng dụng với ID: ${appId}`, true);
                    }
                } else {
                    throw new Error(result.message || 'Dữ liệu không hợp lệ từ server');
                }
            } catch (error) {
                console.error('Error loading app:', error);
                
                if (retryCount < MAX_RETRIES) {
                    showError(`Lỗi tải dữ liệu: ${error.message}. Thử lại?`, true);
                } else {
                    showError(`Không thể tải thông tin ứng dụng sau ${MAX_RETRIES} lần thử. Vui lòng thử lại sau.`, false);
                }
            }
        }
        
        function displayAppDetail(app) {
            const categoryLabels = {
                'game': 'Trò chơi',
                'social': 'Mạng xã hội',
                'entertainment': 'Giải trí',
                'photo': 'Ảnh & Video',
                'clone': 'Nhân bản',
                'premium': 'Mở khoá Premium',
                'education': 'Giáo dục',
                'health': 'Sức khỏe',
                'utility': 'Tiện ích'
            };
            
            let categories = [];
            if (typeof app.categories === 'string') {
                categories = app.categories.split(',');
            } else if (Array.isArray(app.categories)) {
                categories = app.categories;
            }
            
            const tagsHTML = categories.map(cat => 
                `<span class="app-tag">${categoryLabels[cat] || cat}</span>`
            ).join('');
            
            let formattedDate = 'Chưa cập nhật';
            if (app.updatedate) {
                try {
                    const date = new Date(app.updatedate);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleDateString('vi-VN');
                    }
                } catch (e) {
                    formattedDate = app.updatedate;
                }
            }
            
            document.title = `${app.name} - XSpace Store`;
            
            const user = getCurrentUser();
            const loginPrompt = document.getElementById('loginPrompt');
            loginPrompt.style.display = user ? 'none' : 'block';
            
            const freeButton = createDownloadButton(app, false, user);
            const vipButton = createDownloadButton(app, true, user);
            
            const vipPackagesHTML = createVipPackagesHTML(app.vipPackages);
            
            const html = `
                <div class="app-header">
                    <img src="${app.image || 'https://via.placeholder.com/135/2563eb/FFFFFF?text=App'}" 
                         alt="${app.name}" 
                         class="app-icon-large"
                         onerror="this.src='https://via.placeholder.com/135/2563eb/FFFFFF?text=App'">
                    <div class="app-info">
                        <h1 class="app-title">${app.name}</h1>
                        <div class="app-developer">${app.developer || 'Nhà phát triển'}</div>
                        <div class="app-meta">
                            <div class="meta-item">
                                <span class="meta-label">Phiên bản</span>
                                <span class="meta-value">${app.version || '1.0.0'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Cập nhật</span>
                                <span class="meta-value">${formattedDate}</span>
                            </div>
                        </div>
                        <div class="app-tags">${tagsHTML}</div>
                    </div>
                </div>

                <div class="download-section">
                    <h2 class="download-title">Tải ứng dụng</h2>
                    <div class="download-options">
                        ${freeButton}
                        ${vipButton}
                    </div>
                    ${vipPackagesHTML}
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-info-circle"></i>
                        ${app.viplink1 ? 'Premium: No Ads – Full Features – Unlimited Access' : 'Bản VIP đang được cập nhật'}
                    </div>
                </div>

                <div class="description-section" style="margin-bottom: 25px;">
                    <h2 class="section-title" style="font-size: 16px; font-weight: 700; margin-bottom: 10px; color: var(--text-primary);">Mô tả ứng dụng</h2>
                    <div class="app-description-check" style="background: var(--surface); padding: 14px; border-radius: 10px; border: 1px solid var(--border); font-size: 12.5px; line-height: 1.4;">
                        ${app.description ? app.description.split('\n').filter(line => line.trim()).map(line => `
                            <div class="description-item" style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px;">
                                <div class="check-icon-container" style="background: var(--primary); color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 7px; flex-shrink: 0; margin-top: 1px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <span class="description-text" style="color: var(--text-secondary); line-height: 1.4; font-size: 12.5px; flex: 1;">${line.trim()}</span>
                            </div>
                        `).join('') : 'Ứng dụng chưa có mô tả chi tiết.'}
                    </div>
                </div>
            `;
            
            document.getElementById('appContent').innerHTML = html;
        }

        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAppDetail();
        });
        
        window.addEventListener('load', function() {
            clearCache();
        });
    </script>
</body>
</html>
